# US-029: Diff Viewer Stable Base + AI Scope

## What Was Built
Stabilized diff baselines for worktrees, tracked AI-touched files, and scoped diffs to AI edits when available.

### Key Changes

1. **Stable base commit + AI scope filtering** (`src/components/DiffViewer.tsx:14`)
   - Resolve base ref from HEAD when missing and persist it (`src/components/DiffViewer.tsx:54`)
   - Filter summary to AI-touched files and show scope badge (`src/components/DiffViewer.tsx:31`)

2. **AI-touched file tracking** (`src/components/HeadlessChat/index.tsx:50`)
   - Normalize tool paths and capture Edit/Write/MultiEdit/ApplyPatch/NotebookEdit paths (`src/components/HeadlessChat/index.tsx:62`)
   - Store touched files per session (`src/components/HeadlessChat/index.tsx:195`)

3. **Worktree setup passes origin branch + updates cwd** (`src/components/SetupModal.tsx:58`)
   - Export `CLAUDE_ORIGIN_BRANCH` to the setup script (`src/components/SetupModal.tsx:87`)
   - Sync session cwd/finalCwd after script completes (`src/components/SetupModal.tsx:135`)

4. **Session store updates** (`src/store/sessions.ts:164`)
   - Keep cwd/finalCwd aligned when setup completes

5. **Touched files store** (`src/store/touchedFiles.ts:1`)
   - Track per-session touched file list in memory

6. **Git diff ignores submodules** (`src-tauri/src/git.rs:119`)
   - Apply `--ignore-submodules` for summary and file diff commands

7. **Untracked file diffs** (`src-tauri/src/git.rs:42`)
   - Include untracked files in diff summary and file diff output

8. **Font import ordering fix** (`index.html:6`)
   - Load Google Fonts in HTML to avoid PostCSS @import ordering errors

9. **Worktree base ref selection** (`scripts/start-session.sh:24`)
   - Prefer `origin/<branch>` with fallbacks before creating worktree

## E2E Checks

1. **Base commit backfill**
   - DB before: `sessions.base_commit` cleared for `yolo3`
   - Action: opened diff panel for `yolo3`
   - DB after: base commit set to HEAD; header shows short SHA `ab6e896c`

2. **AI-touched diff scope (untracked)**
   - DB before: `sessions.base_commit` checked for `yolo3`
   - Action: Write created `notes/ai-scope-untracked-yolo3.txt`
   - UI: diff scoped to the untracked file with AI scope badge; hunk shows content

3. **Worktree base uses origin branch**
   - Action: created session `e2e-worktree-base-3` via UI
   - Verification: `HEAD` matches `origin/master` in the worktree
   - UI: diff shows only `.mcp.json` with small changes (no mass deletions)

## Commit Hash
24913c059a73d56840a8ab088cc634d50c5f5983
